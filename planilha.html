<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lubrificante - Sistema de Turnos</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        body { 
            background: linear-gradient(to right, #e3f2fd, #fffde7); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            padding: 20px;
        }
        
        /* Container principal centralizado */
        .auth-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            min-height: 100vh;
        }
        
        .container { 
            width: 90vw; 
            max-width: 500px; 
            background: #ffffff; 
            border-radius: 12px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.1); 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }
        
        .login-container { 
            background: white; 
            padding: 50px 40px; 
            border-radius: 16px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.1); 
            width: 100%; 
            max-width: 450px; 
            text-align: center; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .login-logo { 
            max-width: 220px; 
            height: auto; 
            margin-bottom: 40px; 
        }
        
        .form-group { 
            margin-bottom: 25px; 
            text-align: left; 
            width: 100%;
        }
        .form-group label { 
            display: block; 
            margin-bottom: 10px; 
            font-weight: 600; 
            color: #1A355C; 
            font-size: 15px;
        }
        .form-group input { 
            width: 100%; 
            padding: 14px 16px; 
            border: 2px solid #1A355C; 
            border-radius: 8px; 
            background-color: #e3f2fd; 
            color: #1A355C; 
            font-weight: bold; 
            font-size: 16px;
        }
        .form-group input:focus { 
            outline: none; 
            border-color: #1A355C; 
            box-shadow: 0 0 0 3px rgba(26,53,92,0.1); 
        }
        
        button { 
            padding: 14px 24px; 
            border: none; 
            border-radius: 8px;
            font-size: 16px; 
            cursor: pointer; 
            background-color: #1A355C;
            color: #fff; 
            transition: background 0.3s ease; 
            font-weight: bold; 
            width: 100%;
            margin-top: 10px;
        }
        button:hover { background-color: #0F203A; }
        
        .toggle-forms { 
            margin-top: 25px; 
            text-align: center; 
            width: 100%;
        }
        .toggle-forms button { 
            background: none; 
            color: #1A355C; 
            text-decoration: underline; 
            padding: 8px; 
            width: auto; 
            font-size: 15px;
            margin: 0 auto;
        }
        .toggle-forms button:hover { background: none; color: #0F203A; }
        
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(15,23,42,0.7); 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
        }
        .modal-content { 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            width: 450px; 
            max-width: 90%; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.1); 
        }
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px; 
            padding-bottom: 18px; 
            border-bottom: 2px solid #e2e8f0; 
        }
        .close { 
            font-size: 24px; 
            cursor: pointer; 
            color: #64748b; 
        }
        
        .turn-selection { 
            display: flex; 
            justify-content: center; 
            gap: 12px; 
            margin-bottom: 25px; 
        }
        .turn-btn { 
            padding: 12px 20px; 
            font-size: 15px; 
            border: 2px solid #1A355C;
            background-color: #fff; 
            color: #1A355C; 
            border-radius: 8px;
            cursor: pointer; 
            font-weight: bold; 
            transition: background 0.3s;
            flex: 1;
        }
        .turn-btn.active { 
            background-color: #1A355C; 
            color: white; 
        }
        
        /* Estilos para o sistema principal */
        #main-container { 
            width: 95vw; 
            height: 90vh; 
            max-width: none; 
            display: none;
            flex-direction: column;
        }
        
        header { 
            background: linear-gradient(135deg, #1A355C, #0F203A); 
            color: white; 
            padding: 15px 25px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .header-left h1 { 
            font-size: 1.7rem; 
            margin-bottom: 5px; 
            font-weight: 700; 
        }
        .header-left .subtitle { 
            font-size: 0.95rem; 
            opacity: 0.9; 
        }
        .header-info { 
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
            gap: 10px; 
        }
        .info-item { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }
        .info-item span { 
            font-weight: 600; 
            font-size: 1.05rem; 
        }
        
        .turn-controls { 
            padding: 10px 25px; 
            background: #f8fafc; 
            border-bottom: 1px solid #e2e8f0; 
            text-align: center; 
            font-weight: 600;
            color: #1A355C;
        }
        .controls { 
            padding: 12px 25px; 
            background: #f1f5f9; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid #e2e8f0; 
            gap: 15px; 
        }
        .search-box { 
            flex: 1; 
            max-width: 400px; 
            position: relative;
        }
        .search-box input { 
            padding: 10px 14px; 
            border: 2px solid #1A355C; 
            border-radius: 8px; 
            width: 100%; 
            font-size: 0.95rem; 
            background-color: #e3f2fd; 
            color: #1A355C; 
            font-weight: bold; 
        }
        .search-box input:focus { 
            outline: none; 
            border-color: #1A355C; 
            box-shadow: 0 0 0 3px rgba(26,53,92,0.1); 
        }
        
        /* Bot√£o de limpar busca */
        .clear-search {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #7D1A1A;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: auto;
            display: none;
        }
        
        .btn-edit { 
            background-color: #1A355C; 
            color: white; 
            padding: 10px 16px; 
            font-size: 0.85rem; 
            border-radius: 8px;
        }
        
        /* Bot√£o Fechar Turno menor no canto direito */
        .btn-close-shift { 
            background-color: #7D1A1A; 
            color: white; 
            font-weight: 700; 
            padding: 8px 16px; 
            font-size: 0.8rem; 
            border-radius: 6px;
            width: auto;
            margin: 0;
        }
        .btn-close-shift:hover { 
            background-color: #5C1010; 
        }
        
        .main-content { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            position: relative;
        }
        .table-container { 
            flex: 1; 
            overflow: auto; 
            border-bottom: 2px solid #e2e8f0;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.85rem; 
            table-layout: fixed; 
        }
        thead { 
            background: linear-gradient(135deg, #f8fafc, #e2e8f0); 
            position: sticky; 
            top: 0; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        th { 
            padding: 12px 8px; 
            text-align: center; 
            font-weight: 700; 
            color: #1A355C; 
            border-bottom: 2px solid #cbd5e1; 
            font-size: 0.9rem; 
        }
        td { 
            padding: 8px 8px; 
            border-bottom: 1px solid #f1f5f9; 
        }
        .product-name { 
            font-weight: 600; 
            text-align: left; 
            padding-left: 12px; 
        }
        .numeric { 
            text-align: center; 
            font-variant-numeric: tabular-nums; 
        }
        
        .qty-input, .entry-input { 
            width: 70px; 
            padding: 8px 10px; 
            border: 2px solid #1A355C; 
            border-radius: 6px; 
            text-align: center; 
            font-size: 0.85rem; 
            margin: 0 auto; 
            display: block; 
            background-color: #e3f2fd; 
            color: #1A355C; 
            font-weight: bold;
        }
        .qty-input:focus, .entry-input:focus { 
            outline: none; 
            border-color: #1A355C; 
            box-shadow: 0 0 0 2px rgba(26,53,92,0.1); 
            background: #f0f9ff; 
        }
        
        .sale-controls { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            min-width: 150px; 
            margin: 0 auto; 
            padding: 0 10px; 
        }
        .sale-btn { 
            width: 30px; 
            height: 30px; 
            padding: 0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1rem; 
            font-weight: bold; 
            border-radius: 6px; 
            border: none; 
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .sale-plus { 
            background-color: #1A355C; 
            color: white; 
        }
        .sale-plus:hover { 
            background-color: #0F203A; 
        }
        .sale-minus { 
            background-color: #7D1A1A; 
            color: white; 
        }
        .sale-minus:hover { 
            background-color: #5C1010; 
        }
        .sale-qty { 
            min-width: 40px; 
            text-align: center; 
            font-weight: 700; 
            padding: 4px 8px; 
        }
        .sale-total { 
            font-weight: 700; 
            color: #1A355C; 
            margin-left: 12px; 
        }
        
        /* √Årea do Total de Vendas melhorada */
        .sales-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 25px;
            background: #FFF176;
            border-top: 3px solid #FFEB3B;
            margin-top: 0;
        }
        
        .total-vendas { 
            font-weight: 700; 
            color: #5D4037;
            font-size: 1.1rem;
        }
        
        .total-value {
            font-weight: 700;
            color: #1A355C;
            font-size: 1.3rem;
        }
        
        footer { 
            padding: 12px 25px; 
            background: linear-gradient(135deg, #f8fafc, #e2e8f0); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-size: 0.85rem; 
            color: #64748b; 
        }
        
        .footer-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .print-header { display: none; }
        
        .col-produto { width: 28%; } 
        .col-inicial { width: 12%; } 
        .col-valor { width: 10%; }
        .col-entrada { width: 12%; } 
        .col-vendidos { width: 12%; } 
        .col-estoque { width: 12%; } 
        .col-vendas { width: 14%; }

        /* Estilos para o modal de edi√ß√£o de produtos */
        .edit-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .edit-search-box {
            flex: 1;
            position: relative;
        }

        .edit-search-box input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #1A355C;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .sort-controls {
            display: flex;
            gap: 8px;
        }

        .sort-btn {
            padding: 6px 12px;
            border: 1px solid #1A355C;
            background: white;
            color: #1A355C;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .sort-btn.active {
            background: #1A355C;
            color: white;
        }

        /* Modal sobreposto para edi√ß√£o de produto */
        .overlay-modal {
            z-index: 2000;
        }
        
        /* Estilos para impress√£o */
        @media print {
            @page {
                margin: 0.5cm;
            }
            
            body { 
                background: white !important; 
                padding: 0 !important; 
                margin: 0 !important; 
                font-size: 12px !important;
            }
            .container { 
                box-shadow: none !important; 
                border-radius: 0 !important; 
                width: 100% !important; 
                height: auto !important; 
                min-height: auto !important; 
                max-width: none !important; 
                max-height: none !important; 
            }
            .controls, .turn-controls, .btn-close-shift, footer, .sale-controls, 
            header, .header-info, .header-left { 
                display: none !important; 
            }
            
            .qty-input, .entry-input { 
                border: none !important; 
                background: transparent !important; 
                font-size: 10px !important;
            }
            
            /* Cabe√ßalho de impress√£o simples */
            .print-header { 
                display: flex !important; 
                justify-content: flex-end !important; 
                align-items: flex-start !important; 
                gap: 15px !important; 
                margin-bottom: 10px !important; 
                font-size: 10px !important; 
                padding: 0 8px !important;
                page-break-inside: avoid !important;
            }
            .print-header div { 
                display: flex; 
                flex-direction: column; 
                align-items: flex-start; 
                line-height: 1.2 !important; 
            }
            .print-header strong { 
                font-size: 9px !important; 
                margin-bottom: 2px !important; 
                color: #1A355C !important;
            }
            .print-header span { 
                font-size: 10px !important; 
                font-weight: 600 !important;
            }
            
            .sales-summary { 
                display: flex !important; 
                background: #FFF176 !important; 
                border-top: 1px solid #FFEB3B !important; 
                margin-top: 10px !important; 
                padding: 8px 15px !important; 
                font-size: 11px !important; 
                margin-bottom: 0 !important;
                page-break-inside: avoid !important;
            }
            
            table { 
                font-size: 10px !important; 
                margin-top: 0 !important; 
                page-break-inside: avoid !important;
            }
            th, td { 
                padding: 3px 2px !important; 
                line-height: 1.2 !important; 
                border-bottom: 0.5px solid #e2e8f0 !important; 
                font-size: 10px !important;
            }
            
            thead th {
                font-size: 9px !important;
                padding: 4px 2px !important;
                font-weight: 700 !important;
                color: #1A355C !important;
            }
            
            .product-name {
                font-size: 10px !important;
                padding-left: 3px !important;
            }

            /* Uniformizar tamanho dos n√∫meros na impress√£o */
            .numeric, .qty-input, .entry-input, .sale-qty, .sale-total {
                font-size: 10px !important;
                font-family: 'Courier New', monospace !important;
            }
            
            .col-vendas { display: none !important; }
            .col-produto { width: 42% !important; }
            .col-inicial { width: 9% !important; }
            .col-valor { width: 9% !important; }
            .col-entrada { width: 9% !important; }
            .col-vendidos { width: 9% !important; }
            .col-estoque { width: 9% !important; }
            
            tbody tr { 
                page-break-inside: avoid !important; 
                height: 14px !important; 
            }
            .table-container { 
                overflow: visible !important; 
                height: auto !important; 
            }
            
            * { 
                margin: 0 !important; 
                padding: 0 !important; 
            }
            
            /* Remove qualquer data/hora do navegador */
            .date-time, .url, .page-title {
                display: none !important;
            }
        }
        
        /* Bot√µes de sele√ß√£o de turno na tela inicial */
        .shift-selection {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
            width: 100%;
        }
        
        .shift-btn {
            padding: 16px 24px;
            font-size: 16px;
            border: 2px solid #1A355C;
            background-color: #fff;
            color: #1A355C;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            width: 100%;
        }
        
        .shift-btn:hover {
            background-color: #1A355C;
            color: white;
        }
        
        .shift-btn.new-shift {
            background-color: #1A355C;
            color: white;
        }
        
        .shift-btn.continue-shift {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .shift-btn.continue-shift:hover {
            background-color: #388E3C;
        }
        
        /* Modal para continuar turno */
        .continue-shift-modal {
            z-index: 1500;
        }
        
        /* Bot√µes de a√ß√£o no modal de edi√ß√£o */
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-cancel {
            background-color: #ccc;
            color: #333;
            width: auto;
            padding: 8px 16px;
        }
        
        .btn-save, .btn-add {
            background-color: #1A355C;
            color: white;
            width: auto;
            padding: 8px 16px;
        }
        
        .btn-add {
            background-color: #4CAF50;
        }
    </style>
</head>
<body>
    <!-- Tela Inicial com Sele√ß√£o de Turno -->
    <div class="auth-wrapper" id="initial-container">
        <div class="login-container">
            <img src="logo.png" alt="Logo Posto Picor√≥" class="login-logo" />
            
            <div class="shift-selection">
                <button class="shift-btn new-shift" id="new-shift-btn">NOVO TURNO</button>
                <button class="shift-btn continue-shift" id="continue-shift-btn">CONTINUAR TURNO</button>
            </div>
        </div>
    </div>
    
    <!-- Tela de Login/Cadastro Centralizada -->
    <div class="auth-wrapper" id="auth-container" style="display: none;">
        <div class="login-container">
            <img src="logo.png" alt="Logo Posto Picor√≥" class="login-logo" />
            
            <!-- Formul√°rio de Login -->
            <form id="login-form">
                <div class="form-group">
                    <label>C√≥digo de Acesso:</label>
                    <input type="password" id="login-code" required placeholder="Digite seu c√≥digo de acesso" maxlength="6">
                </div>
                <button type="submit" class="btn-login">ACESSAR SISTEMA</button>
            </form>
            
            <!-- Formul√°rio de Cadastro (inicialmente oculto) -->
            <form id="register-form" style="display: none;">
                <div class="form-group">
                    <label>Nome do Frentista Caixa:</label>
                    <input type="text" id="register-name" required placeholder="Digite seu nome completo">
                </div>
                <div class="form-group">
                    <label>C√≥digo de Acesso (m√≠nimo 4 d√≠gitos):</label>
                    <input type="password" id="register-code" required placeholder="Crie um c√≥digo com 4+ d√≠gitos" minlength="4" maxlength="6">
                </div>
                <button type="submit" class="btn-register">CADASTRAR</button>
            </form>
            
            <div class="toggle-forms">
                <button id="toggle-auth">N√£o tem cadastro? Clique aqui</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para continuar turno -->
    <div class="modal continue-shift-modal" id="continue-shift-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Continuar Turno</h2>
                <span class="close" id="close-continue-modal">√ó</span>
            </div>
            <form id="continue-shift-form">
                <div class="form-group">
                    <label>C√≥digo de Acesso:</label>
                    <input type="password" id="continue-code" required placeholder="Digite seu c√≥digo de acesso" maxlength="6">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" id="cancel-continue">Cancelar</button>
                    <button type="submit" class="btn-save">Continuar Turno</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para sele√ß√£o de data e turno -->
    <div class="modal" id="turn-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Selecionar Data e Turno</h2>
                <span class="close" id="close-turn-modal">√ó</span>
            </div>
            <form id="turn-form">
                <div class="form-group">
                    <label>Data:</label>
                    <input type="date" id="session-date" required>
                </div>
                <div class="form-group">
                    <label>Turno:</label>
                    <div class="turn-selection">
                        <button type="button" class="turn-btn" data-turn="1">TURNO 1</button>
                        <button type="button" class="turn-btn" data-turn="2">TURNO 2</button>
                        <button type="button" class="turn-btn" data-turn="3">TURNO 3</button>
                        <button type="button" class="turn-btn" data-turn="4">TURNO 4</button>
                    </div>
                    <input type="hidden" id="session-turn" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-save">INICIAR SISTEMA</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para autentica√ß√£o de administrador -->
    <div class="modal" id="admin-auth-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Acesso de Administrador</h2>
                <span class="close" id="close-admin-modal">√ó</span>
            </div>
            <form id="admin-auth-form">
                <div class="form-group">
                    <label>C√≥digo de Administrador:</label>
                    <input type="password" id="admin-code" required placeholder="Digite o c√≥digo de administrador" maxlength="6">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" id="cancel-admin">Cancelar</button>
                    <button type="submit" class="btn-save">Validar Acesso</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Sistema Principal (inicialmente oculto) -->
    <div class="container" id="main-container">
        <!-- Cabe√ßalho de impress√£o - agora ser√° exibido na impress√£o -->
        <div class="print-header">
            <div><strong>Data:</strong><span id="print-date">--/--/----</span></div>
            <div><strong>Frentista:</strong><span id="print-frentista">--</span></div>
            <div><strong>Turno:</strong><span id="print-turno">--</span></div>
        </div>
        
        <header>
            <div class="header-left">
                <h1>Posto Picor√≥</h1>
                <div class="subtitle">Controle de Lubrificantes</div>
            </div>
            <div class="header-info">
                <div class="info-item"><label>DATA:</label><span id="current-date">--/--/----</span></div>
                <div class="info-item"><label>FRENTISTA CAIXA:</label><span id="frentista-display">--</span></div>
            </div>
        </header>
        
        <div class="turn-controls">TURNO: <span id="turn-display">--</span></div>
        
        <div class="controls">
            <div class="search-box">
                <input type="text" id="search" placeholder="Buscar produto...">
                <button class="clear-search" id="clear-search" title="Limpar busca">‚úï</button>
            </div>
            <div class="buttons">
                <button class="btn-edit" id="edit-products">‚úèÔ∏è Editar Produtos</button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="table-container">
                <table id="products-table">
                    <thead>
                        <tr>
                            <th class="col-produto" style="text-align: left;">PRODUTO</th>
                            <th class="col-inicial">QTD INICIAL</th>
                            <th class="col-valor">VALOR (R$)</th>
                            <th class="col-entrada">ENTRADA</th>
                            <th class="col-vendidos">QTD VENDIDA</th>
                            <th class="col-estoque">ESTOQUE FINAL</th>
                            <th class="col-vendas">VENDAS</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
            
            <!-- √Årea do Total de Vendas melhorada -->
            <div class="sales-summary">
                <div class="total-vendas">TOTAL DE VENDAS:</div>
                <div class="total-value" id="total-sales">R$ 0,00</div>
            </div>
        </div>
        
        <footer>
            <span>Sistema de Controle - Posto Picor√≥</span>
            <div class="footer-right">
                <button class="btn-close-shift" id="close-shift">üìÑ Fechar Turno</button>
            </div>
        </footer>
    </div>
    
    <!-- Modal para edi√ß√£o de produtos (sobreposto) -->
    <div class="modal overlay-modal" id="product-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Adicionar Lubrificante</h2>
                <span class="close" id="close-modal">√ó</span>
            </div>
            <form id="product-form">
                <div class="form-group">
                    <label>Nome do Produto:</label>
                    <input type="text" id="product-name" required>
                </div>
                <div class="form-group">
                    <label>Valor (R$):</label>
                    <input type="number" id="product-value" step="0.01" min="0" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" id="cancel-form">Cancelar</button>
                    <button type="submit" class="btn-save">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Produtos</h2>
                <span class="close" id="close-edit-modal">√ó</span>
            </div>
            
            <!-- Controles de busca e ordena√ß√£o -->
            <div class="edit-controls">
                <div class="edit-search-box">
                    <input type="text" id="edit-search" placeholder="Buscar produto...">
                </div>
                <div class="sort-controls">
                    <button class="sort-btn" data-sort="name">Nome A-Z</button>
                    <button class="sort-btn" data-sort="value">Valor</button>
                </div>
            </div>
            
            <div class="table-container" style="max-height: 350px;">
                <table>
                    <thead>
                        <tr>
                            <th style="text-align: left;">PRODUTO</th>
                            <th>VALOR (R$)</th>
                            <th>A√á√ïES</th>
                        </tr>
                    </thead>
                    <tbody id="edit-table-body"></tbody>
                </table>
            </div>
            <div class="form-actions" style="margin-top: 20px;">
                <button type="button" class="btn-cancel" id="cancel-edit">Fechar</button>
                <button type="button" class="btn-add" id="add-new-product">Adicionar Novo</button>
            </div>
        </div>
    </div>

    <script>
        // Dados iniciais - ADICIONADO O NOVO LUBRIFICANTE
        const initialProducts = [
            { name: "ADITIVO RADIADOR ROOL TECH", value: 16.50 }, 
            { name: "DISCO TAC√ìGRAFO", value: 48.00 },
            { name: "LUBRAX ESSENTIAL 2T 200ml (VERDE)", value: 11.00 }, 
            { name: "LUBRAX ESSENTIAL 2T 500ml (VERDE)", value: 23.00 },
            { name: "LUBRAX ESSENTIAL 2T FC 200ml (AMARELO)", value: 16.00 }, 
            { name: "LUBRAX ESSENTIAL 2T FC 500ml (AMARELO)", value: 31.00 },
            { name: "FLUIDO DE FREIO HI TECH DOT 3 200ml", value: 12.00 }, 
            { name: "FLUIDO DE FREIO HI TECH DOT 4 200ml", value: 12.00 },
            { name: "STIHL", value: 65.00 }, 
            { name: "SPRINT F900 10W40 4T", value: 42.00 }, 
            { name: "SPRINTA F500 10W30", value: 35.00 },
            { name: "SPRINTA F300 20W50", value: 30.00 }, 
            { name: "URANIA 15W40 1 LITRO", value: 45.00 }, 
            { name: "URANIA 15W40 4 LITROS", value: 125.00 },
            { name: "KARTER TASA SUFIXO A", value: 28.00 }, 
            { name: "SYNTIUM 800 10W40", value: 50.00 }, 
            { name: "SYNTIUM 20W50", value: 28.00 },
            { name: "SELENIA PERFORM 5W40", value: 43.00 }, 
            { name: "SELENIA 5W30", value: 36.00 }, 
            { name: "SELENIA K", value: 32.00 },
            { name: "BARDAHL MAX 200ml", value: 25.00 }, 
            { name: "G√ÅS", value: 119.00 }, 
            { name: "G√ÅS CASCO", value: 200.00 },
            { name: "ADITIVO GASOLINA RADNAQ", value: 14.00 } // ADICIONADO AQUI
        ];

        // Usu√°rios administradores
        const adminUsers = [
            { name: "Matheus √Åvila", code: "0112" },
            { name: "Vinicius", code: "2010" },
            { name: "Daniel", code: "1012" }
        ];

        // Banco de dados usando IndexedDB
        const DB_NAME = 'PostoPicoroDB';
        const DB_VERSION = 2; // Aumentei a vers√£o para for√ßar atualiza√ß√£o
        const STORE_USERS = 'users';
        const STORE_PRODUCTS = 'products';
        const STORE_SHIFTS = 'shifts';
        const STORE_ACTIVE_SHIFTS = 'active_shifts';

        let db = null;
        let users = [...adminUsers];
        let products = [...initialProducts];
        let currentEditingIndex = -1;
        let initialQuantities = {};
        let entryQuantities = {};
        let salesData = {};
        let sessionData = {};
        let currentUser = null;
        let currentSearchTerm = '';
        let currentSort = 'name';
        let editSearchTerm = '';
        let isEditSessionActive = false;
        let isNewShift = true;
        let currentShiftId = null;
        
        // Inicializar banco de dados - CORRIGIDO
        function initDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('Erro ao abrir banco de dados');
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    console.log('Banco de dados aberto com sucesso');
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    console.log('Upgrading database to version:', DB_VERSION);
                    
                    // Criar store de usu√°rios
                    if (!db.objectStoreNames.contains(STORE_USERS)) {
                        const userStore = db.createObjectStore(STORE_USERS, { keyPath: 'code' });
                        userStore.createIndex('name', 'name', { unique: false });
                        console.log('Store de usu√°rios criada');
                    }
                    
                    // Criar store de produtos - CORRIGIDO: usa autoIncrement para key
                    if (!db.objectStoreNames.contains(STORE_PRODUCTS)) {
                        const productStore = db.createObjectStore(STORE_PRODUCTS, { keyPath: 'id', autoIncrement: true });
                        productStore.createIndex('name', 'name', { unique: true });
                        productStore.createIndex('value', 'value', { unique: false });
                        console.log('Store de produtos criada');
                    }
                    
                    // Criar store de turnos
                    if (!db.objectStoreNames.contains(STORE_SHIFTS)) {
                        const shiftStore = db.createObjectStore(STORE_SHIFTS, { keyPath: 'id', autoIncrement: true });
                        shiftStore.createIndex('userCode', 'userCode', { unique: false });
                        shiftStore.createIndex('date', 'date', { unique: false });
                        console.log('Store de turnos criada');
                    }
                    
                    // Criar store de turnos ativos
                    if (!db.objectStoreNames.contains(STORE_ACTIVE_SHIFTS)) {
                        const activeShiftStore = db.createObjectStore(STORE_ACTIVE_SHIFTS, { keyPath: 'userCode' });
                        console.log('Store de turnos ativos criada');
                    }
                    
                    // Se estamos atualizando, apagar produtos antigos e recriar
                    if (event.oldVersion < 2) {
                        console.log('Atualizando estrutura do banco de dados');
                    }
                };
            });
        }
        
        // Fun√ß√µes para manipular o banco de dados
        function addItem(storeName, item) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(item);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        function getItem(storeName, key) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(key);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        function getAllItems(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        function updateItem(storeName, item) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(item);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        function deleteItem(storeName, key) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(key);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        // Carregar dados iniciais no banco - CORRIGIDO
        async function loadInitialData() {
            try {
                // Carregar usu√°rios
                const existingUsers = await getAllItems(STORE_USERS);
                if (existingUsers.length === 0) {
                    console.log('Inserindo usu√°rios iniciais...');
                    for (const user of users) {
                        await addItem(STORE_USERS, user);
                    }
                } else {
                    users = existingUsers;
                    console.log('Usu√°rios carregados:', users.length);
                }
                
                // Carregar produtos - CORRIGIDO: sempre verifica e insere se necess√°rio
                const existingProducts = await getAllItems(STORE_PRODUCTS);
                console.log('Produtos existentes no banco:', existingProducts.length);
                
                if (existingProducts.length === 0) {
                    console.log('Inserindo produtos iniciais...');
                    for (const product of initialProducts) {
                        await addItem(STORE_PRODUCTS, { name: product.name, value: product.value });
                    }
                    products = initialProducts;
                } else {
                    products = existingProducts.map(p => ({ name: p.name, value: p.value }));
                    console.log('Produtos carregados do banco:', products.length);
                    
                    // Verifica se o novo produto est√° presente
                    const hasNewProduct = products.some(p => p.name === "ADITIVO GASOLINA RADNAQ");
                    if (!hasNewProduct) {
                        console.log('Adicionando ADITIVO GASOLINA RADNAQ...');
                        await addItem(STORE_PRODUCTS, { name: "ADITIVO GASOLINA RADNAQ", value: 14.00 });
                        products.push({ name: "ADITIVO GASOLINA RADNAQ", value: 14.00 });
                    }
                }
                
                console.log('Produtos ap√≥s carga:', products);
                
            } catch (error) {
                console.error('Erro ao carregar dados iniciais:', error);
                // Em caso de erro, usa os dados locais
                products = initialProducts;
            }
        }
        
        // Fun√ß√µes utilit√°rias
        const formatCurrency = value => !value && value !== 0 ? '' : parseFloat(value).toFixed(2).replace('.', ',');
        
        // MODIFICA√á√ÉO: Fun√ß√£o para calcular estoque final com a nova regra
        const calculateFinalStock = (initialQty, entryQty, salesQty) => {
            // Se ambos quantidade inicial e entrada s√£o 0, estoque final fica 0
            if ((!initialQty || initialQty === 0) && (!entryQty || entryQty === 0)) {
                return 0;
            }
            
            if (!initialQty && initialQty !== 0 && !entryQty && entryQty !== 0) return '';
            return Math.max(0, (parseInt(initialQty) || 0) + (parseInt(entryQty) || 0) - (parseInt(salesQty) || 0));
        };

        // MODIFICA√á√ÉO: Fun√ß√£o para navega√ß√£o com Tab entre linhas
        function handleTabNavigation(event) {
            if (event.key === 'Tab') {
                event.preventDefault();
                const allInputs = Array.from(document.querySelectorAll('.qty-input, .entry-input'));
                const currentIndex = allInputs.indexOf(event.target);
                
                // Se estiver no √∫ltimo campo, volta para o primeiro
                const nextIndex = currentIndex + 1 >= allInputs.length ? 0 : currentIndex + 1;
                
                if (allInputs[nextIndex]) {
                    allInputs[nextIndex].focus();
                    allInputs[nextIndex].select();
                }
            }
        }

        // MODIFICA√á√ÉO: Fun√ß√£o para atualizar estoque final quando os campos mudam
        function updateFinalStock(productId) {
            const initialQty = initialQuantities[productId] || 0;
            const entryQty = entryQuantities[productId] || 0;
            const saleInfo = salesData[productId] || { quantity: 0 };
            const finalStock = calculateFinalStock(initialQty, entryQty, saleInfo.quantity);
            
            // Atualiza a exibi√ß√£o do estoque final na tabela
            const row = document.querySelector(`input[data-product="${productId}"]`).closest('tr');
            if (row) {
                const finalStockCell = row.querySelector('td:nth-child(6)'); // Coluna do estoque final
                if (finalStockCell) {
                    finalStockCell.textContent = finalStock;
                }
            }
            
            return finalStock;
        }

        // Fun√ß√£o para obter data atual do Brasil
        function getBrazilianDate() {
            const now = new Date();
            // Ajusta para o fuso hor√°rio do Brasil (UTC-3)
            const offset = -3 * 60; // UTC-3 em minutos
            const brazilTime = new Date(now.getTime() + (offset - now.getTimezoneOffset()) * 60000);
            return brazilTime.toISOString().split('T')[0];
        }

        // Fun√ß√£o para gerar e baixar relat√≥rio em HTML
        function generateAndDownloadReport() {
            // Primeiro, abre a impress√£o
            window.print();
            
            // Depois de um pequeno delay, gera o HTML para download
            setTimeout(() => {
                // Gera o conte√∫do do relat√≥rio
                const reportContent = generateReportContent();
                
                // Cria um blob com o conte√∫do HTML
                const blob = new Blob([reportContent], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                // Cria um link para download
                const a = document.createElement('a');
                a.href = url;
                
                // Nome do arquivo com data e turno
                const dateObj = new Date(sessionData.date + 'T00:00:00');
                const day = String(dateObj.getDate()).padStart(2, '0');
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const year = dateObj.getFullYear();
                const fileName = `Relatorio_Turno${sessionData.turn}_${day}${month}${year}_${sessionData.frentistaName.replace(/\s+/g, '_')}.html`;
                
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                
                // Limpa
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            }, 1000);
        }

        // Fun√ß√£o para gerar o conte√∫do do relat√≥rio HTML id√™ntico ao da impress√£o
        function generateReportContent() {
            const totalVendas = calculateTotalSales();
            const dateObj = new Date(sessionData.date + 'T00:00:00');
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const year = dateObj.getFullYear();
            const formattedDate = `${day}/${month}/${year}`;
            
            // Coleta todos os dados da tabela vis√≠vel (considerando busca/filtro)
            let tableContent = '';
            let visibleProducts = products;
            
            // Se h√° termo de busca, filtra como na tabela vis√≠vel
            if (currentSearchTerm) {
                visibleProducts = products.filter(product => 
                    product.name.toLowerCase().includes(currentSearchTerm.toLowerCase())
                );
            }
            
            visibleProducts.forEach(product => {
                const productId = product.name.replace(/\s+/g, '_').toLowerCase();
                const initialQty = initialQuantities[productId] || 0;
                const entryQty = entryQuantities[productId] || 0;
                const saleInfo = salesData[productId] || { quantity: 0, productName: product.name };
                const saleTotal = saleInfo.quantity * product.value;
                const finalStock = calculateFinalStock(initialQty, entryQty, saleInfo.quantity);
                
                tableContent += `
                    <tr>
                        <td class="product-name" style="text-align: left; padding: 3px 2px; font-size: 10px;">${product.name}</td>
                        <td class="numeric" style="text-align: center; padding: 3px 2px; font-size: 10px; font-family: 'Courier New', monospace;">${initialQty}</td>
                        <td class="numeric" style="text-align: center; padding: 3px 2px; font-size: 10px; font-family: 'Courier New', monospace;">${formatCurrency(product.value)}</td>
                        <td class="numeric" style="text-align: center; padding: 3px 2px; font-size: 10px; font-family: 'Courier New', monospace;">${entryQty}</td>
                        <td class="numeric" style="text-align: center; padding: 3px 2px; font-size: 10px; font-family: 'Courier New', monospace;">${saleInfo.quantity}</td>
                        <td class="numeric" style="text-align: center; padding: 3px 2px; font-size: 10px; font-family: 'Courier New', monospace;">${finalStock}</td>
                    </tr>
                `;
            });
            
            // Gera HTML id√™ntico ao da impress√£o
            return `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio Turno ${sessionData.turn} - ${formattedDate}</title>
    <style>
        @page {
            margin: 0.5cm;
        }
        
        * { 
            margin: 0 !important; 
            padding: 0 !important; 
            box-sizing: border-box !important;
            font-family: 'Roboto', sans-serif !important;
        }
        
        body { 
            background: white !important; 
            padding: 0 !important; 
            margin: 0 !important; 
            font-size: 12px !important;
            width: 100% !important;
            min-height: 100vh !important;
        }
        
        .container { 
            width: 100% !important; 
            height: auto !important; 
            min-height: auto !important; 
            max-width: none !important; 
            max-height: none !important;
            box-shadow: none !important; 
            border-radius: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        
        /* Cabe√ßalho de impress√£o */
        .print-header { 
            display: flex !important; 
            justify-content: flex-end !important; 
            align-items: flex-start !important; 
            gap: 15px !important; 
            margin-bottom: 10px !important; 
            font-size: 10px !important; 
            padding: 0 8px !important;
            page-break-inside: avoid !important;
        }
        
        .print-header div { 
            display: flex; 
            flex-direction: column; 
            align-items: flex-start; 
            line-height: 1.2 !important; 
        }
        
        .print-header strong { 
            font-size: 9px !important; 
            margin-bottom: 2px !important; 
            color: #1A355C !important;
        }
        
        .print-header span { 
            font-size: 10px !important; 
            font-weight: 600 !important;
        }
        
        /* Tabela */
        table { 
            width: 100% !important; 
            border-collapse: collapse !important; 
            font-size: 10px !important; 
            margin-top: 0 !important; 
            page-break-inside: avoid !important;
        }
        
        thead { 
            background: linear-gradient(135deg, #f8fafc, #e2e8f0) !important; 
            position: static !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important; 
        }
        
        th { 
            padding: 4px 2px !important; 
            text-align: center !important; 
            font-weight: 700 !important; 
            color: #1A355C !important; 
            border-bottom: 2px solid #cbd5e1 !important; 
            font-size: 9px !important; 
        }
        
        td { 
            padding: 3px 2px !important; 
            line-height: 1.2 !important; 
            border-bottom: 0.5px solid #e2e8f0 !important; 
            font-size: 10px !important;
        }
        
        .product-name {
            font-size: 10px !important;
            padding-left: 3px !important;
            text-align: left !important;
        }

        .numeric {
            text-align: center !important;
            font-variant-numeric: tabular-nums !important;
            font-size: 10px !important;
            font-family: 'Courier New', monospace !important;
        }
        
        /* √Årea do Total de Vendas */
        .sales-summary {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 8px 15px !important;
            background: #FFF176 !important;
            border-top: 2px solid #FFEB3B !important;
            margin-top: 10px !important;
            font-size: 11px !important;
            margin-bottom: 0 !important;
            page-break-inside: avoid !important;
        }
        
        .total-vendas { 
            font-weight: 700 !important; 
            color: #5D4037 !important;
            font-size: 11px !important;
        }
        
        .total-value {
            font-weight: 700 !important;
            color: #1A355C !important;
            font-size: 12px !important;
        }
        
        /* Remove qualquer data/hora do navegador */
        .date-time, .url, .page-title {
            display: none !important;
        }
        
        /* Layout de colunas igual ao da impress√£o */
        .col-produto { width: 42% !important; }
        .col-inicial { width: 9% !important; }
        .col-valor { width: 9% !important; }
        .col-entrada { width: 9% !important; }
        .col-vendidos { width: 9% !important; }
        .col-estoque { width: 9% !important; }
        
        tbody tr { 
            page-break-inside: avoid !important; 
            height: 14px !important; 
        }
        
        .table-container { 
            overflow: visible !important; 
            height: auto !important; 
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Cabe√ßalho de impress√£o -->
        <div class="print-header">
            <div><strong>Data:</strong><span>${formattedDate}</span></div>
            <div><strong>Frentista:</strong><span>${sessionData.frentistaName}</span></div>
            <div><strong>Turno:</strong><span>Turno ${sessionData.turn}</span></div>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th class="col-produto" style="text-align: left;">PRODUTO</th>
                        <th class="col-inicial">QTD INICIAL</th>
                        <th class="col-valor">VALOR (R$)</th>
                        <th class="col-entrada">ENTRADA</th>
                        <th class="col-vendidos">QTD VENDIDA</th>
                        <th class="col-estoque">ESTOQUE FINAL</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableContent}
                </tbody>
            </table>
        </div>
        
        <!-- √Årea do Total de Vendas -->
        <div class="sales-summary">
            <div class="total-vendas">TOTAL DE VENDAS:</div>
            <div class="total-value">R$ ${formatCurrency(totalVendas)}</div>
        </div>
        
        <!-- Rodap√© simples para o arquivo baixado -->
        <div style="text-align: center; margin-top: 20px; font-size: 9px; color: #666; padding: 10px;">
            Sistema de Controle - Posto Picor√≥<br>
            Relat√≥rio gerado em ${new Date().toLocaleString('pt-BR')}
        </div>
    </div>
</body>
</html>
            `;
        }

        // Sistema de autentica√ß√£o
        function toggleAuthForms() {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const toggleBtn = document.getElementById('toggle-auth');
            
            if (loginForm.style.display === 'none') {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                toggleBtn.textContent = 'N√£o tem cadastro? Clique aqui';
            } else {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                toggleBtn.textContent = 'J√° tem cadastro? Fazer login';
            }
        }

        async function registerUser(name, code) {
            try {
                // Verifica se o c√≥digo j√° existe
                const existingUser = await getItem(STORE_USERS, code);
                if (existingUser) {
                    alert('Este c√≥digo de acesso j√° est√° em uso. Por favor, escolha outro.');
                    return false;
                }
                
                // Adiciona o novo usu√°rio
                const newUser = { name, code };
                await addItem(STORE_USERS, newUser);
                users.push(newUser);
                
                alert('Cadastro realizado com sucesso! Agora fa√ßa login com seu c√≥digo.');
                toggleAuthForms();
                return true;
            } catch (error) {
                console.error('Erro ao registrar usu√°rio:', error);
                alert('Erro ao registrar usu√°rio. Tente novamente.');
                return false;
            }
        }

        async function loginUser(code) {
            try {
                const user = await getItem(STORE_USERS, code);
                if (user) {
                    currentUser = user;
                    return true;
                } else {
                    alert('C√≥digo de acesso inv√°lido. Tente novamente.');
                    return false;
                }
            } catch (error) {
                console.error('Erro ao fazer login:', error);
                alert('Erro ao fazer login. Tente novamente.');
                return false;
            }
        }

        // Fun√ß√£o para autenticar administrador
        function authenticateAdmin(code) {
            const admin = adminUsers.find(admin => admin.code === code);
            if (admin) {
                isEditSessionActive = true;
                return true;
            } else {
                alert('C√≥digo de administrador inv√°lido. Tente novamente.');
                return false;
            }
        }

        // Fun√ß√£o para verificar se precisa autenticar como admin
        function checkAdminAccess() {
            // Se j√° est√° em uma sess√£o de edi√ß√£o, n√£o precisa autenticar novamente
            if (isEditSessionActive) {
                return Promise.resolve(true);
            }
            
            document.getElementById('admin-auth-modal').style.display = 'flex';
            document.getElementById('admin-code').focus();
            document.getElementById('admin-code').value = '';
            return new Promise((resolve) => {
                const adminForm = document.getElementById('admin-auth-form');
                const handleSubmit = (e) => {
                    e.preventDefault();
                    const code = document.getElementById('admin-code').value;
                    if (code.length < 4) {
                        alert('O c√≥digo de administrador deve ter pelo menos 4 d√≠gitos.');
                        return;
                    }
                    if (authenticateAdmin(code)) {
                        document.getElementById('admin-auth-modal').style.display = 'none';
                        adminForm.removeEventListener('submit', handleSubmit);
                        resolve(true);
                    }
                };
                adminForm.addEventListener('submit', handleSubmit);
                
                // Cancelar autentica√ß√£o
                const cancelAuth = () => {
                    document.getElementById('admin-auth-modal').style.display = 'none';
                    adminForm.removeEventListener('submit', handleSubmit);
                    resolve(false);
                };
                
                document.getElementById('close-admin-modal').addEventListener('click', cancelAuth);
                document.getElementById('cancel-admin').addEventListener('click', cancelAuth);
            });
        }

        // Fun√ß√£o para selecionar o turno
        function selecionarTurno(turno) {
            document.querySelectorAll('.turn-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const btnSelecionado = document.querySelector(`.turn-btn[data-turn="${turno}"]`);
            btnSelecionado.classList.add('active');
            
            document.getElementById('session-turn').value = turno;
        }

        // Fun√ß√£o para verificar se h√° turno ativo para o usu√°rio
        async function checkActiveShift(userCode) {
            try {
                const activeShift = await getItem(STORE_ACTIVE_SHIFTS, userCode);
                return activeShift;
            } catch (error) {
                console.error('Erro ao verificar turno ativo:', error);
                return null;
            }
        }

        // Fun√ß√£o para salvar turno ativo
        async function saveActiveShift(shiftData) {
            try {
                await updateItem(STORE_ACTIVE_SHIFTS, shiftData);
            } catch (error) {
                console.error('Erro ao salvar turno ativo:', error);
            }
        }

        // Fun√ß√£o para remover turno ativo
        async function removeActiveShift(userCode) {
            try {
                await deleteItem(STORE_ACTIVE_SHIFTS, userCode);
                return true;
            } catch (error) {
                console.error('Erro ao remover turno ativo:', error);
                return false;
            }
        }

        // Fun√ß√£o para salvar dados do turno - CORRIGIDO
        async function saveShiftData() {
            try {
                const shiftData = {
                    id: currentShiftId,
                    userCode: currentUser.code,
                    date: sessionData.date,
                    turn: sessionData.turn,
                    frentistaName: currentUser.name,
                    initialQuantities: { ...initialQuantities },
                    entryQuantities: { ...entryQuantities },
                    salesData: { ...salesData },
                    timestamp: new Date().getTime()
                };
                
                await updateItem(STORE_SHIFTS, shiftData);
                await saveActiveShift({
                    userCode: currentUser.code,
                    shiftId: currentShiftId
                });
                
                console.log('Turno salvo com sucesso');
                return true;
            } catch (error) {
                console.error('Erro ao salvar dados do turno:', error);
                return false;
            }
        }

        // Fun√ß√£o para carregar dados do turno
        async function loadShiftData(shiftId) {
            try {
                const shiftData = await getItem(STORE_SHIFTS, shiftId);
                if (shiftData) {
                    initialQuantities = { ...shiftData.initialQuantities };
                    entryQuantities = { ...shiftData.entryQuantities };
                    salesData = { ...shiftData.salesData };
                    console.log('Dados do turno carregados:', shiftData);
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Erro ao carregar dados do turno:', error);
                return false;
            }
        }

        // MODIFICA√á√ÉO: Inicializa√ß√£o do sistema principal com foco autom√°tico
        async function initializeSystem(date, turn, shiftId = null) {
            sessionData = { 
                frentistaName: currentUser.name, 
                date: date, 
                turn: turn 
            };
            
            // Formata a data corretamente
            const dateObj = new Date(date + 'T00:00:00'); // Garante o fuso hor√°rio correto
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const year = dateObj.getFullYear();
            
            const formattedDate = `${day}/${month}/${year}`;
            
            document.getElementById('current-date').textContent = formattedDate;
            document.getElementById('frentista-display').textContent = currentUser.name;
            document.getElementById('turn-display').textContent = `Turno ${turn}`;
            
            // Atualiza tamb√©m o cabe√ßalho de impress√£o
            document.getElementById('print-date').textContent = formattedDate;
            document.getElementById('print-frentista').textContent = currentUser.name;
            document.getElementById('print-turno').textContent = `Turno ${turn}`;
            
            document.getElementById('initial-container').style.display = 'none';
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('main-container').style.display = 'flex';
            document.getElementById('turn-modal').style.display = 'none';
            
            // Se √© um novo turno, cria um ID √∫nico
            if (isNewShift) {
                currentShiftId = Date.now();
                
                // Salva o turno inicial
                await saveShiftData();
            } else {
                currentShiftId = shiftId;
                
                // Carrega os dados do turno
                await loadShiftData(shiftId);
            }
            
            renderTable();
            
            // MODIFICA√á√ÉO: Focar no primeiro campo de quantidade inicial ap√≥s um pequeno delay
            setTimeout(() => {
                const firstInput = document.querySelector('.qty-input');
                if (firstInput) {
                    firstInput.focus();
                    firstInput.select();
                }
            }, 100);
            
            // Salva automaticamente a cada 30 segundos
            setInterval(async () => {
                await saveShiftData();
            }, 30000);
        }

        // Fun√ß√£o para limpar busca
        function clearSearch() {
            document.getElementById('search').value = '';
            currentSearchTerm = '';
            document.getElementById('clear-search').style.display = 'none';
            renderTable();
        }

        // Fun√ß√£o para ordenar produtos
        function sortProducts(productsToSort, sortType) {
            const sorted = [...productsToSort];
            switch(sortType) {
                case 'name':
                    return sorted.sort((a, b) => a.name.localeCompare(b.name));
                case 'value':
                    return sorted.sort((a, b) => a.value - b.value);
                default:
                    return sorted;
            }
        }

        // Fun√ß√£o para aplicar busca nos produtos de edi√ß√£o
        function filterEditProducts() {
            let filtered = products;
            
            if (editSearchTerm) {
                filtered = filtered.filter(product => 
                    product.name.toLowerCase().includes(editSearchTerm.toLowerCase())
                );
            }
            
            return sortProducts(filtered, currentSort);
        }

        // Restante do c√≥digo do sistema (renderTable, calculateTotalSales, etc.)
        function calculateTotalSales() {
            let total = 0;
            Object.values(salesData).forEach(sale => {
                if (sale && sale.quantity > 0) {
                    const product = products.find(p => p.name === sale.productName);
                    if (product) total += sale.quantity * product.value;
                }
            });
            document.getElementById('total-sales').textContent = `R$ ${formatCurrency(total)}`;
            return total;
        }

        // MODIFICA√á√ÉO: Fun√ß√£o renderTable atualizada com as novas funcionalidades
        function renderTable(filteredProducts = products) {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';
            
            // Se h√° termo de busca, filtra os produtos
            if (currentSearchTerm) {
                filteredProducts = products.filter(product => 
                    product.name.toLowerCase().includes(currentSearchTerm.toLowerCase())
                );
            }
            
            filteredProducts.forEach((product, index) => {
                const productId = product.name.replace(/\s+/g, '_').toLowerCase();
                const initialQty = initialQuantities[productId] || '';
                const entryQty = entryQuantities[productId] || '';
                const saleInfo = salesData[productId] || { quantity: 0, productName: product.name };
                const saleTotal = saleInfo.quantity * product.value;
                const finalStock = calculateFinalStock(initialQty, entryQty, saleInfo.quantity);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="product-name">${product.name}</td>
                    <td class="numeric"><input type="number" class="qty-input" data-product="${productId}" value="${initialQty}" placeholder="0" min="0" data-row="${index}"></td>
                    <td class="numeric">${formatCurrency(product.value)}</td>
                    <td class="numeric"><input type="number" class="entry-input" data-product="${productId}" value="${entryQty}" placeholder="0" min="0" data-row="${index}"></td>
                    <td class="numeric">${saleInfo.quantity}</td>
                    <td class="numeric">${finalStock}</td>
                    <td class="numeric">
                        <div class="sale-controls">
                            <button class="sale-btn sale-minus" data-product="${productId}" data-action="decrease">-</button>
                            <span class="sale-qty">${saleInfo.quantity}</span>
                            <button class="sale-btn sale-plus" data-product="${productId}" data-action="increase">+</button>
                            <span class="sale-total">R$ ${formatCurrency(saleTotal)}</span>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Adicionar event listeners para os inputs
            document.querySelectorAll('.qty-input, .entry-input').forEach(input => {
                input.addEventListener('change', function() {
                    const productId = this.getAttribute('data-product');
                    const value = this.value ? parseInt(this.value) : '';
                    
                    if (this.classList.contains('qty-input')) {
                        initialQuantities[productId] = value;
                    } else {
                        entryQuantities[productId] = value;
                    }
                    
                    // MODIFICA√á√ÉO: Atualiza o estoque final automaticamente
                    updateFinalStock(productId);
                    
                    // Salva automaticamente e recalcula totais
                    saveShiftData();
                    calculateTotalSales();
                });
                
                // MODIFICA√á√ÉO: Navega√ß√£o com Tab
                input.addEventListener('keydown', handleTabNavigation);
            });
            
            document.querySelectorAll('.sale-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-product');
                    const action = this.getAttribute('data-action');
                    const product = products.find(p => p.name.replace(/\s+/g, '_').toLowerCase() === productId);
                    if (!product) return;
                    
                    if (!salesData[productId]) salesData[productId] = { quantity: 0, productName: product.name };
                    if (action === 'increase') salesData[productId].quantity += 1;
                    else if (action === 'decrease' && salesData[productId].quantity > 0) salesData[productId].quantity -= 1;
                    
                    // MODIFICA√á√ÉO: Atualiza o estoque final
                    updateFinalStock(productId);
                    
                    // Salva automaticamente e atualiza a tabela
                    saveShiftData();
                    calculateTotalSales();
                    
                    // Atualiza apenas a linha afetada para melhor performance
                    const row = this.closest('tr');
                    if (row) {
                        const saleQtyElement = row.querySelector('.sale-qty');
                        const saleTotalElement = row.querySelector('.sale-total');
                        const saleTotal = salesData[productId].quantity * product.value;
                        
                        if (saleQtyElement) saleQtyElement.textContent = salesData[productId].quantity;
                        if (saleTotalElement) saleTotalElement.textContent = `R$ ${formatCurrency(saleTotal)}`;
                        
                        // Atualiza tamb√©m a coluna de quantidade vendida
                        const soldQtyCell = row.querySelector('td:nth-child(5)');
                        if (soldQtyCell) soldQtyCell.textContent = salesData[productId].quantity;
                        
                        // Atualiza estoque final
                        const finalStockCell = row.querySelector('td:nth-child(6)');
                        if (finalStockCell) {
                            const initialQty = initialQuantities[productId] || 0;
                            const entryQty = entryQuantities[productId] || 0;
                            finalStockCell.textContent = calculateFinalStock(initialQty, entryQty, salesData[productId].quantity);
                        }
                    }
                });
            });
            
            calculateTotalSales();
        }

        async function openProductModal(index = -1) {
            currentEditingIndex = index;
            document.getElementById('modal-title').textContent = index === -1 ? 'Adicionar Lubrificante' : 'Editar Lubrificante';
            if (index !== -1) {
                const product = products[index];
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-value').value = product.value;
            } else {
                document.getElementById('product-form').reset();
            }
            document.getElementById('product-modal').style.display = 'flex';
            document.getElementById('product-name').focus();
        }

        document.getElementById('product-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const product = {
                name: document.getElementById('product-name').value,
                value: parseFloat(document.getElementById('product-value').value)
            };
            
            if (currentEditingIndex === -1) {
                products.push(product);
                await addItem(STORE_PRODUCTS, product);
            } else {
                products[currentEditingIndex] = product;
                // Para atualizar, precisamos primeiro obter o ID do produto existente
                const allProducts = await getAllItems(STORE_PRODUCTS);
                const existingProduct = allProducts.find(p => p.name === product.name);
                if (existingProduct) {
                    await updateItem(STORE_PRODUCTS, { ...existingProduct, ...product });
                } else {
                    await addItem(STORE_PRODUCTS, product);
                }
            }
            
            document.getElementById('product-modal').style.display = 'none';
            renderEditTable();
            renderTable();
        });

        function renderEditTable() {
            const editTableBody = document.getElementById('edit-table-body');
            editTableBody.innerHTML = '';
            
            const filteredProducts = filterEditProducts();
            
            filteredProducts.forEach((product, index) => {
                const originalIndex = products.findIndex(p => p.name === product.name);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td class="numeric">${formatCurrency(product.value)}</td>
                    <td>
                        <button class="btn-edit edit-product-btn" data-index="${originalIndex}">Editar</button>
                        <button class="btn-remove remove-product-btn" data-index="${originalIndex}">Remover</button>
                    </td>
                `;
                editTableBody.appendChild(row);
            });
            
            document.querySelectorAll('.edit-product-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.getAttribute('data-index'));
                    openProductModal(index);
                });
            });
            
            document.querySelectorAll('.remove-product-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const index = parseInt(e.target.getAttribute('data-index'));
                    if (confirm(`Tem certeza que deseja remover "${products[index].name}"?`)) {
                        // Para remover do banco, precisamos primeiro obter o ID do produto
                        const allProducts = await getAllItems(STORE_PRODUCTS);
                        const productToDelete = allProducts.find(p => p.name === products[index].name);
                        if (productToDelete) {
                            await deleteItem(STORE_PRODUCTS, productToDelete.id);
                        }
                        products.splice(index, 1);
                        renderEditTable();
                        renderTable();
                    }
                });
            });
        }

        async function openEditModal() {
            // Verifica se o usu√°rio est√° autenticado como admin
            const isAuthenticated = await checkAdminAccess();
            if (!isAuthenticated) return;
            
            // Reseta estado de busca e ordena√ß√£o
            editSearchTerm = '';
            document.getElementById('edit-search').value = '';
            currentSort = 'name';
            
            // Ativa bot√£o de ordena√ß√£o padr√£o
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.sort-btn[data-sort="name"]').classList.add('active');
            
            renderEditTable();
            document.getElementById('edit-modal').style.display = 'flex';
        }

        // Fun√ß√£o para finalizar sess√£o de edi√ß√£o
        function endEditSession() {
            isEditSessionActive = false;
            document.getElementById('edit-modal').style.display = 'none';
        }

        // Event Listeners
        document.getElementById('toggle-auth').addEventListener('click', toggleAuthForms);

        document.getElementById('login-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const code = document.getElementById('login-code').value;
            if (code.length < 4) {
                alert('O c√≥digo de acesso deve ter pelo menos 4 d√≠gitos.');
                return;
            }
            const success = await loginUser(code);
            if (success) {
                document.getElementById('turn-modal').style.display = 'flex';
            }
        });

        document.getElementById('register-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const name = document.getElementById('register-name').value;
            const code = document.getElementById('register-code').value;
            
            if (name.trim() === '') {
                alert('Por favor, informe seu nome.');
                return;
            }
            
            if (code.length < 4) {
                alert('O c√≥digo de acesso deve ter pelo menos 4 d√≠gitos.');
                return;
            }
            
            await registerUser(name, code);
        });

        document.getElementById('turn-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const date = document.getElementById('session-date').value;
            const turn = document.getElementById('session-turn').value;
            
            if (!date || !turn) {
                alert('Por favor, selecione a data e o turno.');
                return;
            }
            
            await initializeSystem(date, turn);
        });

        document.querySelectorAll('.turn-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const turno = this.getAttribute('data-turn');
                selecionarTurno(turno);
            });
        });

        document.getElementById('close-turn-modal').addEventListener('click', () => {
            document.getElementById('turn-modal').style.display = 'none';
        });

        // Bot√µes de sele√ß√£o de turno na tela inicial
        document.getElementById('new-shift-btn').addEventListener('click', function() {
            isNewShift = true;
            document.getElementById('initial-container').style.display = 'none';
            document.getElementById('auth-container').style.display = 'flex';
        });

        document.getElementById('continue-shift-btn').addEventListener('click', function() {
            document.getElementById('continue-shift-modal').style.display = 'flex';
            document.getElementById('continue-code').focus();
        });

        document.getElementById('continue-shift-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const code = document.getElementById('continue-code').value;
            
            if (code.length < 4) {
                alert('O c√≥digo de acesso deve ter pelo menos 4 d√≠gitos.');
                return;
            }
            
            const success = await loginUser(code);
            if (success) {
                // Verifica se h√° turno ativo para este usu√°rio
                const activeShift = await checkActiveShift(code);
                if (activeShift) {
                    isNewShift = false;
                    document.getElementById('continue-shift-modal').style.display = 'none';
                    
                    // Carrega os dados do turno
                    const shiftData = await getItem(STORE_SHIFTS, activeShift.shiftId);
                    if (shiftData) {
                        await initializeSystem(shiftData.date, shiftData.turn, activeShift.shiftId);
                    } else {
                        alert('Erro ao carregar dados do turno. Iniciando novo turno.');
                        document.getElementById('turn-modal').style.display = 'flex';
                    }
                } else {
                    alert('Nenhum turno ativo encontrado para este usu√°rio. Inicie um novo turno.');
                    document.getElementById('continue-shift-modal').style.display = 'none';
                    document.getElementById('turn-modal').style.display = 'flex';
                }
            }
        });

        document.getElementById('close-continue-modal').addEventListener('click', () => {
            document.getElementById('continue-shift-modal').style.display = 'none';
        });

        document.getElementById('cancel-continue').addEventListener('click', () => {
            document.getElementById('continue-shift-modal').style.display = 'none';
        });

        // Busca de produtos melhorada
        document.getElementById('search').addEventListener('input', function() {
            currentSearchTerm = this.value;
            if (currentSearchTerm) {
                document.getElementById('clear-search').style.display = 'block';
            } else {
                document.getElementById('clear-search').style.display = 'none';
            }
            renderTable();
        });

        // Busca na edi√ß√£o de produtos
        document.getElementById('edit-search').addEventListener('input', function() {
            editSearchTerm = this.value;
            renderEditTable();
        });

        // Ordena√ß√£o na edi√ß√£o de produtos
        document.querySelectorAll('.sort-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const sortType = this.getAttribute('data-sort');
                currentSort = sortType;
                
                document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                renderEditTable();
            });
        });

        document.getElementById('clear-search').addEventListener('click', clearSearch);

        // MODIFICA√á√ÉO AQUI: Agora ao fechar turno, gera relat√≥rio, remove turno ativo e zera dados
        document.getElementById('close-shift').addEventListener('click', async () => {
            if (confirm('ATEN√á√ÉO: Ao fechar o turno, todas as informa√ß√µes ser√£o zeradas e n√£o ser√° poss√≠vel continuar este turno. Deseja realmente fechar o turno e gerar o relat√≥rio?')) {
                // Gera relat√≥rio
                generateAndDownloadReport();
                
                // Remove turno ativo
                await removeActiveShift(currentUser.code);
                
                // Zera dados locais
                initialQuantities = {};
                entryQuantities = {};
                salesData = {};
                currentShiftId = null;
                
                // Volta para tela inicial
                document.getElementById('main-container').style.display = 'none';
                document.getElementById('initial-container').style.display = 'flex';
                
                alert('Turno fechado com sucesso! Todas as informa√ß√µes foram zeradas.');
            }
        });

        // Event Listeners para modais
        document.getElementById('edit-products').addEventListener('click', openEditModal);
        document.getElementById('close-modal').addEventListener('click', () => document.getElementById('product-modal').style.display = 'none');
        document.getElementById('close-edit-modal').addEventListener('click', endEditSession);
        document.getElementById('cancel-form').addEventListener('click', () => document.getElementById('product-modal').style.display = 'none');
        document.getElementById('cancel-edit').addEventListener('click', endEditSession);
        document.getElementById('add-new-product').addEventListener('click', () => {
            openProductModal();
        });

        window.addEventListener('click', (event) => {
            if (event.target === document.getElementById('product-modal')) document.getElementById('product-modal').style.display = 'none';
            if (event.target === document.getElementById('edit-modal')) {
                endEditSession();
            }
            if (event.target === document.getElementById('turn-modal')) document.getElementById('turn-modal').style.display = 'none';
            if (event.target === document.getElementById('admin-auth-modal')) document.getElementById('admin-auth-modal').style.display = 'none';
            if (event.target === document.getElementById('continue-shift-modal')) document.getElementById('continue-shift-modal').style.display = 'none';
        });

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Inicializa o banco de dados
                await initDatabase();
                await loadInitialData();
                
                // Recarrega produtos do banco
                const allProducts = await getAllItems(STORE_PRODUCTS);
                products = allProducts.map(p => ({ name: p.name, value: p.value }));
                
                console.log('Produtos carregados na inicializa√ß√£o:', products.length);
                console.log('Produtos:', products);
                
                // Recarrega usu√°rios do banco
                const allUsers = await getAllItems(STORE_USERS);
                users = allUsers;
                
                initialQuantities = {};
                entryQuantities = {};
                salesData = {};
                sessionData = {};
                
                // Define a data atual do Brasil como padr√£o
                const dataBrasil = getBrazilianDate();
                document.getElementById('session-date').value = dataBrasil;
                document.getElementById('session-date').min = dataBrasil;
                document.getElementById('session-date').max = dataBrasil;
                
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                alert('Erro ao inicializar o sistema. Por favor, recarregue a p√°gina.');
            }
        });
    </script>
</body>
</html>
